<?php
/**
 * @file
 * The Birthdays module allows users to add their birthday to their
 * profile. It lists birthdays on a seperate page and in different
 * blocks. Users can receive an e-mail on their birthday automatically,
 * and the administrator can receive daily reminders of who are having
 * their birthday. Requires Profile Module.
 */

/**
 * Admin e-mails disabled. Default.
 */
define('BIRTHDAYS_ADMIN_MAIL_DISABLED', '0');

/**
 * Admin e-mails should be sent dayly.
 */
define('BIRTHDAYS_ADMIN_MAIL_DAILY', '1');

/**
 * Admin e-mails should be sent weekly, on the first day of the week defined
 * by 'admin/settings/date-time'.
 */
define('BIRTHDAYS_ADMIN_MAIL_WEEKLY', '2');

/**
 * Admin e-mails should be sent monthly, on the first day of the month.
 */
define('BIRTHDAYS_ADMIN_MAIL_MONTHLY', '3');


/**
 * Do not show starsigns. Default.
 */
define('BIRTHDAYS_STARSIGN_OFF', '0');

/**
 * Show starsigns, with link to Yahoo.
 */
define('BIRTHDAYS_STARSIGN_LINK', '1');

/**
 * Show starsigns, image only.
 */
define('BIRTHDAYS_STARSIGN_NOLINK', '2');

/**
 * Do not hide the year of birth and age of users. This goes for all pages
 * generated by the Birthdays module. Default.
 */
define('BIRTHDAYS_HIDE_YEAR_NO', '0');

/**
 * Hide the year of birth and age of users. This goes for all pages
 * generated by the Birthdays module.
 */
define('BIRTHDAYS_HIDE_YEAR_YES', '1');

/**
 * Hiding or showing the year of birth and age is up to the user. This goes
 * for all pages generated by the Birthdays module.
 */
define('BIRTHDAYS_HIDE_YEAR_USER', '2');

/**
 * User does not want the birth year and age to be hidden. Used when
 * hiding the year is an user option.
 */
define('BIRTHDAYS_HIDE_YEAR_USER_NO', '0');

/**
 * User wants birth year and age to be hidden. Used when
 * hiding the year is an user option.
 */
define('BIRTHDAYS_HIDE_YEAR_USER_YES', '1');
/**
 * Do not show users without a birthday on the Birthdays listing
 * and sort by birthday. Default.
 */
define('BIRTHDAYS_PAGE_FILTER_SORT_DATE', '0');

/**
 * Do not show users without a birthday on the Birthdays listing
 * and sort by username.
 */
define('BIRTHDAYS_PAGE_FILTER_SORT_USER', '1');

/**
 * Show all users on the Birthdays listing and sort by username.
 */
define('BIRTHDAYS_PAGE_NOFILTER_SORT_USER', '2');

/**
 * Do not send an e-mail to the user on their birthday. Default.
 */
define('BIRTHDAYS_USER_MAIL_NO', '0');

/**
 * Send an e-mail to the user on their birthday.
 */
define('BIRTHDAYS_USER_MAIL_YES', '1');

/**
 * Sending an e-mail to the user depends on that user's preference.
 */
define('BIRTHDAYS_USER_MAIL_USER', '2');

/**
 * User doesn't want to be e-mailed on their birthday.
 */
define('BIRTHDAYS_USER_MAIL_USER_NO', '1');

/**
 * User wants to be e-mailed on their birthday.
 */
define('BIRTHDAYS_USER_MAIL_USER_YES', '0');

/**
 * Implementation of hook_help().
 */
function birthdays_help($path, $arg) {
  global $_birthdays_field;
  switch ($path) {
    case 'admin/help#birthdays':
      $output = '<p>' . t("The Birthdays module allows a user to put in their birthday and display it in their profile, on a separate Birthdays page and in a block. It also has the option to send out e-mails on users's birthdays, and to notify the administrator periodically about upcoming birthdays via e-mail.") . '</p>';
      $output .= '<p>' . t('Some basic information about this module can be found below. For more information, support questions, feature requests and bug reports please visit the <a href="@project_url">Birthdays project page</a> and the <a href="@documentation_url">online documentation</a>.', array('@project_url' => 'http://drupal.org/project/birthdays', '@documentation_url' => 'http://drupal.org/node/315658')) . '</p>';
      $output .= '<h2>' . t('Configuring the module') . '</h2>';
      $output .= '<p>' . t('Configuring the module is done on a number of pages.') . '</p>';
      $output .= '<h3>' . t('Birthdays administration pages') . '</h3>';
      $output .= '<p>' . t('The <a href="@birthdays_admin">Birthdays administration pages</a> are where the actual features of the birthdays module are set. Some of the options are described below.', array('@birthdays_admin' => url('admin/settings/birthdays'))) . '</p>';
      $output .= '<ul><li><strong>' . t('Profile field') . '</strong>: ' . t('here you set which "date" field of the Profile module you want the Birthdays module to use.') . '</li>';
      $output .= '<li><strong>' . t('Show star signs') . '</strong>: ' . t('select whether you want to display the star sign icons on the profile and on the Birthdays page, and, if so, whether it should link to Yahoo Horoscopes.') . '</li>';
      $output .= '<li><strong>' . t('Hide year and age') . '</strong>: ' . t("some sites might want to protect the user's privacy by hiding their age and year of birth. The options are 'No', 'Yes' and 'User optional, defaults to No', where the latter gives the user the option to  select whether he or she wants this information to be hidden. If enabled it still requires them to put the full date of birth in, but only the day and month will be displayed.") . '</li>';
      $output .= '<li><strong>' . t('Set Birthdays page settings') . '</strong>: ' . t('this influences how the listing of the Birthdays page is shown. Sorted by user name of date of birth (year not included) and users without a birthday shown or not.') . '</li>';
      $output .= '<li><strong>' . t('Show filter options') . '</strong>: ' . t("determine whether the buttons to filter by specific month and/or year should be displayed. When 'Hide year and age' is set to 'Yes', filtering by year is not possible.") . '</li>';
      $output .= '<li><strong>' . t('Send upcoming birthdays to admin') . '</strong>: ' . t("this one has 4 values 'Disabled', 'Dayly', 'Weekly, on the first day of the week' and 'Monthly'. This will send an e-mail to your site e-mail address at the given intervals, listing users that will have their birthday in that period. The first day of the week is controlled by the <a href=\"@date_settings\">date and time settings</a>.", array('@date_settings' => url('admin/settings/date-time'))) . '</li>';
      $output .= '<li><strong>' . t('Send user e-mail on day of birth') . '</strong>: ' . t("set whether users should receive an e-mail when they are having the birthday. Either 'No', 'Yes' or 'User optional, 'Yes' by default', where the latter leaves the decision up to the user.") . '</li></ul>';

      $output .= '<h3>' . t('Permissions') . '</h3>';
      $output .= '<p>' . t('To allow users to view birthdays of other people, the "access birthdays" <a href="@permissions_page">permissions</a> needs to be set for the appropriate role. This allows them to access the <a href="@birthdays_page">Birthdays page</a>, see activated blocks with birthdays and view the birthdays of users in the profiles.', array('@birthdays_page' => url('birthdays'), '@permissions_page' => url('admin/user/permissions', array('fragment' => 'module-birthdays')))) . '</p>';

      $output .= '<h3>' . t('Profile field settings') . '</h3>';

      $output .= '<p>' . t("Several things can be adjusted to the assigned profile field. To do so please visit the !profile_admin, and edit the field in question or add one if you haven't done so already. The following settings require extra attention.", array('!profile_admin' => l('Profile settings', 'admin/user/profile'))) . '</p>';

      $output .= '<ul><li><strong>' . t('The user must enter a value') . '</strong>: ' . t('force the user to fill in their date of  birth. A once set birthday can not be deleted.') . '</li>';
      $output .= '<li><strong>' . t('Visible in user registration form') . '</strong>: ' . t('give new users the option to add their date of birth when registering to your website. If combined with the option above, they can not register without putting their date of birth.') . '</li>';
      $output .= '<li><strong>' . t('Visibility') . '</strong>: ' . t("this will influence the visibility of the field as described there, but the behavior might become erratic if not set to 'Public field, content shown on profile page but not used on member list pages'. So it is recommended to leave this as is.") . '</li></ul>';
      $output .= '<p>' . t('The other options on this page behave as described on the settings page.') . '</p>';

      $output .= '<h3>' . t('Date format') . '</h3>';
      $output .= '<p>' . t('The way the birthdays are formatted (e.g. <em>11 may 1934</em> or <em>5/11/1934</em>) is controlled by the <a href="@date_settings_page">date and time settings</a>. The Birthdays module uses the short date format as basis for displaying days and months in the blocks and the medium date format is used in the profile and on the Birthdays page.', array('!date_settings_page' => url('admin/settings/date-time'))) . '</p>';

      $output .= '<h2>' . t('Synchronizing') . '</h2>';

      $output .= '<p>' . t('The birthdays are saved to two different database tables. This is because the profile module saves the dates in a format which limits the ability to perform calculations on the dates. These two tables need to be in sync with each other.') . '</p>';
      $output .= '<p>' . t('Normally this is the case, but sometimes not. For example when you already collected birthdays with the Profile module, but later decided to switch to the birthdays module. Or when you accidentally (on intentionally) completely uninstalled the profile module, but left birthdays module merely disabled. To perform the synchronization you can use the <a href="@sync_pages">synchronization form</a>.', array('@sync_page' => url('admin/settings/birthdays/sync'))) . '</p>';
      $output .= '<p>' . t('In the first case you need to copy the Profile data to the (most likely empty) Birthdays table, which is done with the top button. In the latter you need the copy the birthdays in the Birthdays table back to the Profile module with the bottom button.') . '</p>';
      $output .= '<p>' . t('Please note that with a large amount of users this might take some time.') . '</p>';

      return $output;
    case 'admin/settings/birthdays':
      return t('Use this page to alter the settings of the Birthdays module.');
  }
}

/**
 * Implements hook_field_info().
 */
function birthdays_field_info() {
  return array(
    'birthdays_date' => array(
      'label' => t('Birthday'),
      'description' => t('This field stores a birthday in the database.'),
      'default_widget' => 'birthdays_textfield',
      'default_formatter' => 'birthdays_plaintext',
      'instance_settings' => array(
        'admin_mail' => BIRTHDAYS_ADMIN_MAIL_DISABLED,
        'user_mail' => BIRTHDAYS_USER_MAIL_NO,
        'hide_year' => BIRTHDAYS_HIDE_YEAR_NO,
      ),
    ),
  );
}

/**
 * Implements hook_field_validate().
 */
function birthdays_field_validate($entity_type, $entity, $field, $instance, $langcode, &$items, &$errors) {
  foreach ($items as $delta => $item) {
    try {
      BirthdaysBirthday::fromArray($item);
    }
    catch (InvalidArgumentException $e) {
      $errors[$field['field_name']][$langcode][$delta][] = array(
        'error' => 'birthdays_invalid',
        'message' => t("That is not a valid birthday."),
      );
    }
  }
}

/**
 * Implements hook_field_is_empty().
 */
function birthdays_field_is_empty($item, $field) {
  try {
    return BirthdaysBirthday::fromArray($item)->isEmpty();
  }
  catch (InvalidArgumentException $e) {
    return FALSE;
  }
}

/**
 * Implements hook_field_formatter_info().
 */
function birthdays_field_formatter_info() {
  return array(
    'birthdays_plaintext' => array(
      'label' => t('Plaintext'),
      'field types' => array('birthdays_date'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function birthdays_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();

  if ($display['type'] = 'birthdays_plaintext') {
    foreach ($items as $delta => $item) {
      $element[$delta] = array('#markup' => BirthdaysBirthday::fromArray($item)->toString());
    }
  }

  return $element;
}

/**
 * Implements hoook_field_widget_info().
 */
function birthdays_field_widget_info() {
  return array(
    'birthdays_textfield' => array(
      'label' => t('Textfield'),
      'field types' => array('birthdays_date'),
    ),
  );
}

/**
 * Implement hook_field_widget_form().
 */
function birthdays_field_widget_form(&$form, &$form_state, $field, $instance, $langcode, $items, $delta = 0) {
  $element = array(
    '#type' => 'textfield',
    '#element_validate' => array('_birthdays_textfield_validate'),
    '#langcode' => $langcode,
    '#size' => 10,
    '#title' => $instance['label'],
    '#description' => isset($instance['description']) ? $instance['description'] : '',
  );

  if (isset($items[$delta])) {
    $element['#default_value'] = BirthdaysBirthday::fromArray($items[$delta])->toString();
  }

  return $element;
}

/**
 * FAPI validation callback for the birthdays_field_widget_form element.
 */
function _birthdays_textfield_validate($element, &$form_state) {
  try {
    $birthday = BirthdaysBirthday::fromString($element['#value']);
    form_set_value($element, $birthday->toArray(), $form_state);
  }
  catch (InvalidArgumentException $e) {
    form_error($element, t('That is not a valid birthday. Enter the date as <em>day.month.year</em>, <em>year/month/day</em> or <em>year-month-day</em>. You can skip the year.'));
  }
}

/**
 * Implements hook_field_widget_error().
 */
function birthdays_field_widget_error($element, $error) {
  form_error($element, $error['message']);
}

/**
 * Implements hook_field_instance_settings_form().
 */
function birthdays_field_instance_settings_form($field, $instance) {
  $settings = $instance['settings'];

  // Year settings.
  $form['hide_year'] = array(
    '#type' => 'radios',
    '#title' => t('Year settings'),
    '#default_value' => $settings['hide_year'],
    '#description' => t('Make entering a year optional, required or forbidden.'),
    '#options' => array(
      BIRTHDAYS_HIDE_YEAR_NO => t('Require the user to enter a year'),
      BIRTHDAYS_HIDE_YEAR_USER => t('Let the user decide, if he wants to enter a year'),
      BIRTHDAYS_HIDE_YEAR_YES => t('Don\'t allow the user to enter a year'),
    ),
  );

  // E-Mail notifications for administrators.
  $form['notifications'] = array(
    '#type' => 'fieldset',
    '#title' => t('Email notifications'),
    'admin_mail' => array(
      '#type' => 'radios',
      '#title' => t('Birthday reminder for the administrator'),
      '#default_value' => $settings['admin_mail'],
      '#description' => t('The site administrator can be reminded of upcoming birthdays via email.'),
      '#options' => array(
        BIRTHDAYS_ADMIN_MAIL_DISABLED => t('Send <strong>no</strong> reminders'),
        BIRTHDAYS_ADMIN_MAIL_DAILY => t('Send <strong>daily</strong> reminders'),
        BIRTHDAYS_ADMIN_MAIL_WEEKLY => t('Send <strong>weekly</strong> reminders, on the first day of the week'),
        BIRTHDAYS_ADMIN_MAIL_MONTHLY => t('Send <strong>monthly</strong> reminders, on the first day of the month'),
      ),
      '#element_validate' => array('_birthdays_admin_mail_validate'),
    ),
    'user_mail' => array(
      '#type' => 'item',
      '#title' => t('User notification'),
      '#description' => t('You can send an email or execute other actions on birthdays using the trigger module.'),
    ),
  );

  // Provide information about triggers.
  if (module_exists('trigger')) {
    $trigger_info = t('Trigger module is enabled. You can !configure_triggers and !actions.', array(
      '!configure_triggers' => l('configure triggers', 'admin/structure/trigger/birthdays'),
      '!actions' => l('actions', 'admin/config/system/actions'),
    ));
  }
  else {
    $trigger_info = t('Go to the !module_page and enable the Trigger module', array(
      '!module_page' => l('module page', 'admin/modules'),
    ));
  }
  $form['notifications']['user_mail']['#description'] .= ' ' . $trigger_info;

  return $form;
}

/**
 * FAPI validation for the admin mail period selection.
 */
function _birthdays_admin_mail_validate($element, &$form_state, $form) {
  // The notifications fieldset is only for the ui, not for logic.
  $form_state['values']['instance']['settings']['admin_mail'] = $element['#value'];
  unset($form_state['values']['instance']['settings']['notifications']);
}

/**
 * Implements hook_views_api().
 */
function birthdays_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'birthdays') . '/views',
  );
}

/**
 * Implements hook_trigger_info().
 *
 * @todo:
 *   Find a better solution to per field instance triggers.
 */
function birthdays_trigger_info() {
  $triggers = array();

  foreach (_birthdays_field_instances() as $instance) {
    // The name is supposed to be a hook name, but we want more granular hooks
    // without implementing them all. So we generate a unique key and implement
    // only hook_birthdays().
    $name = md5('birthdays|' . $instance['entity_type'] . '|' . $instance['bundle'] . '|' . $instance['field_name']);

    // Create a localized label for the trigger.
    $label = _birthdays_instance_description($instance) . ' ' . t('(On Birthdays)');

    // Add it to the list of triggers.
    $triggers['birthdays'][$name] = array('label' => $label);
  };

  return $triggers;
}

/**
 * Get a human readable description of a field instance.
 *
 * @param $instance
 *   The field instance.
 *
 * @return
 *   A localized string.
 */
function _birthdays_instance_description($instance) {
  $vars = array(
    '@entity_type' => $instance['entity_type'],
    '@bundle' => $instance['bundle'],
    '@field_name' => $instance['field_name'],
  );

  if ($instance['entity_type'] == $instance['bundle']) {
    $desc = t('@entity_type: @field_name', $vars);
  }
  else {
    $desc = t('@entity_type: @bundle: @field_name', $vars);
  }

  return $desc;
}



/**
 * Implements hook_birthdays().
 */
function birthdays_birthdays($entity, $instance) {
  // Require the trigger module.
  if (!module_exists('trigger')) {
    return;
  }

  // Context information.
  $context = array(
    'group' => 'birthdays',
    'hook' => md5('birthdays|' . $instance['entity_type'] . '|' . $instance['bundle'] . '|' . $instance['field_name']),
    $instance['entity_type'] => $entity,
  );

  // Execute the matching set of actions.
  $aids = trigger_get_assigned_actions($context['hook']);
  actions_do(array_keys($aids), $entity, $context, $instance);
}

/**
 * Get all instances of birthday fields that are around.
 */
function _birthdays_field_instances() {
  $result = array();

  // Get the instances.
  foreach (field_info_fields() as $field) {
    if ($field['type'] == 'birthdays_date') {
      foreach ($field['bundles'] as $entity_type => $bundles) {
        foreach ($bundles as $bundle) {
          $result[] = field_info_instance($entity_type, $field['field_name'], $bundle);
        }
      }
    }
  }

  // Sort them.
  usort($result, '_birthdays_field_instances_compare');

  return $result;
}

/**
 * Comparison callback to sort an array of field instances by entity type,
 * bundle name and field name as humans would do.
 *
 * @see strnatcmp
 */
function _birthdays_field_instances_compare($a, $b) {
  // Entity types have first priority.
  if ($result = strnatcmp($a['entity_type'], $b['entity_type'])) {
    return $result;
  }

  // Next are bundle names.
  if ($result = strnatcmp($a['bundle'], $b['bundle'])) {
    return $result;
  }

  // The field name at last.
  return strnatcmp($a['field_name'], $b['field_name']);
}

/**
 * Query the database for birthdays.
 *
 * @param $instance
 *   The field instance to query for.
 * @param $day
 *   The day to look up.
 * @param $month
 *   The month to look up.
 * @param $year
 *   Optional. If that year is not a leap year and $day and $month indicate the
 *   first of March, then February 29 will be included in the query.
 *
 * @return
 *   An array where both keys and values are entity ids.
 */
function _birthdays_get($instance, $day, $month, $year = NULL) {
  $field_name = $instance['field_name'];

  $result = db_select('field_data_' . $field_name, 'f')
    ->fields('f', array('entity_id'))
    ->condition($field_name . '_day', $day)
    ->condition($field_name . '_month', $month)
    ->condition('entity_type', $instance['entity_type'])
    ->condition('bundle', $instance['bundle'])
    ->execute()
    ->fetchAllKeyed(0, 0);

  if ($year && $day == 1 && $month == 3 && !BirthdaysBirthday::isLeapYear($year)) {
    $result += _birthdays_get($instance, 29, 2);
  }

  return $result;
}

/**
 * Implementation of hook_cron().
 */
function birthdays_cron() {
  global $_birthdays_field;

  // Either user mail or admin mail is activated, and the birthdays profile field has been set.
  if (isset($_birthdays_field) && (variable_get('birthdays_send_user', BIRTHDAYS_USER_MAIL_NO) != BIRTHDAYS_USER_MAIL_NO || variable_get('birthdays_remind', BIRTHDAYS_ADMIN_MAIL_DISABLED) != BIRTHDAYS_ADMIN_MAIL_DISABLED)) {
    // Perform the check just once a day
    $time = time();
    if (variable_get('birthdays_last_cron', 0) <= ($time - 24*3600)) {
      // The message functions are now necessary, lets include them.
      module_load_include('inc', 'birthdays', 'birthdays.mail');
      // Reset time limit, round to nearest 100 seconds.
      variable_set('birthdays_last_cron', floor($time/100)*100);

      $remind_frequency = variable_get('birthdays_remind', BIRTHDAYS_ADMIN_MAIL_DISABLED);

      // Send user e-mails.
      _birthdays_send_user_message();

      // Send admin message if frequency is daily.
      if ($remind_frequency == BIRTHDAYS_ADMIN_MAIL_DAILY) {
        _birthdays_send_admin_message(1);
      }// Send admin message if frequency is weekly and today is the first day of the week.
      elseif ($remind_frequency == BIRTHDAYS_ADMIN_MAIL_WEEKLY && date('w', $time) == variable_get('date_first_day', 0)) {
        _birthdays_send_admin_message(7);
      }// Send admin message if frequency is monthly and today is the first day of the month.
      elseif ($remind_frequency == BIRTHDAYS_ADMIN_MAIL_MONTHLY && date('j', $time) == 1) {
        _birthdays_send_admin_message(date('t', $time));
      }
    }
  }
}

/**
 *  Helper function for displaying only todays birthdays
 *  @return An array containing all user objects that have their birthday today
 */
function birthdays_get_todays_birthdays() {
  return birthdays_get_birthdays_by_days(1);
}


/**
 * Get all birthdays of the upcomming X days
 *
 * @var $amount
 *   Integer stating the amount of days to look forward, including today.
 * @return array
 *   An array containing user objects meeting the criteria
 */
function birthdays_get_birthdays_by_days($amount) {
  $birthdays = array();
  // Current user, needed for timezone information
  global $user;

  // $amount should be larger or equal to 1
  if ($amount < 1) {
    $amount = 1;
  }

  // Get user time zone
  // needed to determine what day 'today' is in the timezone of the user/website.
  if (variable_get('configurable_timezones', 1) && $user->uid && drupal_strlen($user->timezone)) {
    $timezone = $user->timezone;
  }
  else { // else use timezone of Drupal installation
    $timezone = variable_get('date_default_timezone', 0);
  }

  // MySQL prior to 4.1.1 has no option to use UTC, while drupal uses UTC.
  // This is compensated by subtracting the machines timezone from the Drupal timezone.
  // I believe the assumption is that the HTTP-server has the same timezone as the MySQL server.
  $timezone -= date('Z');

  // Hack to look further than the end of the year, if needed.
  $current_year = date('Y');
  $next_year = $current_year + 1;

  /* Query:
    - All dates are compensated for the timezone. This makes sure that someone in Asia will see the birthdays
      of day 2 while someone in America still sees day 1.
    - Blocked users are not shown
    - Users that haven't logged in yet are also not shown (Drupal prohibits accessing their profile, thus showing
      a link to the profile is unwanted). This is a anti spammers method.
    - First part selects all birthdays that are in the next year when the interval exceeds the end of this year.
    - Second part selects all birthdays that are between the begin and end date and are in the current year
    */

  switch ($GLOBALS['db_type']) {
    case 'mysql':
    case 'mysqli':
      $result = db_query(
        "SELECT {dob}.uid FROM {dob}, {users} WHERE {users}.uid = {dob}.uid AND {users}.status <> 0 AND {users}.access <> 0
        AND (
        (
          DATE_FORMAT({dob}.birthday,'$next_year%%m%%d') - DATE_FORMAT(ADDDATE(ADDDATE(NOW(),INTERVAL %d SECOND),INTERVAL %d DAY),'%%Y%%m%%d') < 0
        )
        OR
        (
          DATE_FORMAT({dob}.birthday,'$current_year%%m%%d') - DATE_FORMAT(ADDDATE(NOW(),INTERVAL %d SECOND),'%%Y%%m%%d') >= 0
          AND
          DATE_FORMAT({dob}.birthday,'$current_year%%m%%d') - DATE_FORMAT(ADDDATE(ADDDATE(NOW(),INTERVAL %d SECOND),INTERVAL %d DAY),'%%Y%%m%%d') < 0
        ) )
        ORDER BY MONTH({dob}.birthday), DAYOFMONTH({dob}.birthday), YEAR({dob}.birthday), {users}.name", $timezone, $amount, $timezone, $timezone, $amount
      );
      break;
    case 'pgsql':
      $result = db_query(
        "SELECT {dob}.uid FROM {dob}, {users} WHERE {users}.uid = {dob}.uid AND {users}.status <> 0 AND {users}.access <> 0
        AND (
        (
          cast(to_char({dob}.birthday,'{$next_year}MMDD') as integer) - cast(to_char(current_timestamp + INTERVAL '%d seconds' + INTERVAL '%d days','YYYYMMDD') as integer) < 0
        )
        OR
        (
          cast(to_char({dob}.birthday,'{$current_year}MMDD') as integer) - cast(to_char(current_timestamp + INTERVAL '%d seconds','YYYYMMDD') as integer) >= 0
          AND
          cast(to_char({dob}.birthday,'{$current_year}MMDD') as integer) - cast(to_char(current_timestamp + INTERVAL '%d seconds' + INTERVAL '%d days','YYYYMMDD') as integer) < 0
        ) )
        ORDER BY date_part('month', {dob}.birthday), date_part('day', {dob}.birthday), date_part('year', {dob}.birthday), {users}.name", $timezone, $amount, $timezone, $timezone, $amount
      );
      break;
  }

  while ($account = db_fetch_object($result)) {
    $birthdays[] = $account->uid;
  }

  // Return array of uids that have their birthday
  return $birthdays;
}


/**
 * Get the next X birthdays
 *
 * @var $amount
 *   Integer stating the amount of birthdays to retrieve.
 * @return array
 *   An array containing user objects meeting the criteria
 */
function birthdays_get_birthdays($amount) {
  $birthdays = array();

  // Current logged in user
  global $user;

  // Get user time zone
  // Needed to determine what day 'today' is in the timezone of the user/website.
  if (variable_get('configurable_timezones', 1) && $user->uid && drupal_strlen($user->timezone)) {
    $timezone = $user->timezone;
  }
  else {
    $timezone = variable_get('date_default_timezone', 0);
  }

  // $amount should be larger or equal to 1
  if ($amount < 1) {
    $amount = 1;
  }

  // MySQL prior to 4.1.1 has no option to use UTC, while drupal uses UTC.
  // This is compensated by subtracting the machines timezone from the Drupal timezone.
  // I believe the assumption is that the HTTP-server has the same timezone as the MySQL server.
  $timezone -= date('Z');

  /* Query:
    - Select all active users that have their birthday today or in the future (stops at 31-12)
    - return at most $amount users
    - Don't show blocked users
    - Users that haven't logged in yet are also not shown (Drupal prohibits accessing their profile, thus showing
      a link to the profile is unwanted). This is a anti spammers method.
  */
  switch ($GLOBALS['db_type']) {
    case 'mysql':
    case 'mysqli':
      $result = db_query_range(
        "SELECT {dob}.uid FROM {dob}, {users} WHERE {users}.uid = {dob}.uid AND {users}.status <> 0 AND {users}.access <> 0
        AND DATE_FORMAT({dob}.birthday,'%%c%%d') - DATE_FORMAT(ADDDATE(NOW(),INTERVAL %d SECOND),'%%c%%d') >= 0
        ORDER BY MONTH({dob}.birthday), DAYOFMONTH({dob}.birthday), YEAR({dob}.birthday), {users}.name", $timezone, 0, $amount
      );
      break;
    case 'pgsql':
      $result = db_query_range(
        "SELECT {dob}.uid FROM {dob}, {users} WHERE {users}.uid = {dob}.uid AND {users}.status <> 0 AND {users}.access <> 0
        AND cast(to_char({dob}.birthday,'FMMMDD') as integer) - cast(to_char(current_timestamp + INTERVAL '%d seconds','FMMMDD') as integer) >= 0
        ORDER BY date_part('month', {dob}.birthday), date_part('day', {dob}.birthday), date_part('year', {dob}.birthday), {users}.name", $timezone, 0, $amount
      );
      break;
  }
  $count_rows = 0;
  while ($account = db_fetch_object($result)) {
    $birthdays[] = $account->uid;
    $count_rows++;
  }

  // If less than $amount results returned, look for more after 31-12
  // return at most the difference between the number already found and
  if ($count_rows < $amount) {
    switch ($GLOBALS['db_type']) {
      case 'mysql':
      case 'mysqli':
        $result = db_query_range(
          "SELECT {dob}.uid FROM {dob}, {users} WHERE {users}.uid = {dob}.uid AND {users}.status <> 0 AND {users}.access <> 0
          AND DATE_FORMAT({dob}.birthday,'%%c%%d') - DATE_FORMAT(ADDDATE(NOW(),INTERVAL %d SECOND),'%%c%%d') < 0
          ORDER BY MONTH({dob}.birthday), DAYOFMONTH({dob}.birthday), YEAR({dob}.birthday), {users}.name", $timezone, 0, $amount - $count_rows
        );
        break;
      case 'pgsql':
        $result = db_query_range(
          "SELECT {dob}.uid FROM {dob}, {users} WHERE {users}.uid = {dob}.uid AND {users}.status <> 0 AND {users}.access <> 0
          AND cast(to_char({dob}.birthday,'FMMMDD') as integer) - cast(to_char(current_timestamp + INTERVAL '%d seconds','FMMMDD') as integer) < 0
          ORDER BY date_part('month', {dob}.birthday), date_part('day', {dob}.birthday), date_part('year', {dob}.birthday), {users}.name", $timezone, 0, $amount - $count_rows
        );
        break;
    }

    while ($account = db_fetch_object($result)) {
      $birthdays[] = $account->uid;
    }
  }

  // Return array of uids that have their birthday
  return $birthdays;
}

/**
 * Adds user options to the profile form which are saved in {users}.data and
 * are loaded during a user_load().
 * @return fields for the form
 */
function birthdays_form_user($edit, $account, $category, $register = FALSE) {
  global $_birthdays_field;
  drupal_add_css(drupal_get_path('module','birthdays') . '/birthdays.css', 'module');

  // If the called category is the category of the form field
  if ($category == $_birthdays_field->category || ($_birthdays_field->register && $register)) {
    // If the hiding of the year is a user option: show the option
    if (variable_get('birthdays_hide_year', BIRTHDAYS_HIDE_YEAR_NO) == BIRTHDAYS_HIDE_YEAR_USER) {
      $form[$_birthdays_field->category][$_birthdays_field->name]['birthdays_user_hide_year'] = array(
        '#type' => 'checkbox',
        '#title' => t("Hide age and birth year"),
        '#default_value' => (int) $account->birthdays_user_hide_year,
        '#description' => t("Do not show your age and your year of birth."),
        '#return_value' => BIRTHDAYS_HIDE_YEAR_USER_YES,
        '#weight' => 1,
        '#prefix' => '<div class="birthdays-container">',
        '#suffix' => '</div>',
      );
    }

    // If the birthday user mail is optionally, show the option
    if (variable_get('birthdays_send_user', BIRTHDAYS_USER_MAIL_NO) == BIRTHDAYS_USER_MAIL_USER) {
      $form[$_birthdays_field->category][$_birthdays_field->name]['birthdays_user_send_mail'] = array(
        '#type' => 'checkbox',
        '#title' => t("Do not send birthday mail"),
        '#default_value' => (int) $account->birthdays_user_send_mail,
        '#description' => t("Do not send me an e-mail or e-card when it's my birthday."),
        '#return_value' => BIRTHDAYS_USER_MAIL_USER_NO,
        '#weight' => 2,
        '#prefix' => '<div class="birthdays-container">',
        '#suffix' => '</div>',
      );
    }
  }

  return $form;
}

/**
 * Get starsign based on date of birth
 *
 * @var $day and $month, decribing date of birth
 * @return The name of the starsign
 */
function _birthdays_get_starsign($day, $month) {

  switch ($month) {
    case 1:
      $starsign = $day < 20 ? 'capricorn' : 'aquarius';
      break;
    case 2:
      $starsign = $day < 19 ? 'aquarius' : 'pisces';
      break;
    case 3:
      $starsign = $day < 21 ? 'pisces' : 'aries';
      break;
    case 4:
      $starsign = $day < 20 ? 'aries' : 'taurus';
      break;
    case 5:
      $starsign = $day < 21 ? 'taurus' : 'gemini';
      break;
    case 6:
      $starsign = $day < 22 ? 'gemini' : 'cancer';
      break;
    case 7:
      $starsign = $day < 23 ? 'cancer' : 'leo';
      break;
    case 8:
      $starsign = $day < 23 ? 'leo' : 'virgo';
      break;
    case 9:
      $starsign = $day < 23 ? 'virgo' : 'libra';
      break;
    case 10:
      $starsign = $day < 23 ? 'libra' : 'scorpio';
      break;
    case 11:
      $starsign = $day < 23 ? 'scorpio' : 'sagittarius';
      break;
    case 12:
      $starsign = $day < 22 ? 'sagittarius' : 'capricorn';
      break;
  }

  return $starsign;
}

/**
 * Return the picture of a starsign, given the name. Links to Yahoo! when option is selected.
 *
 * @param string starsign
 *   name of the starsign to show (not translated)
 * @param int $show
 *   Show starsigns for values > 0
 * @return string
 *   HTML of a picture link to Yahoo horoscopes
 */
function birthdays_get_starsign_image($starsign, $show = BIRTHDAYS_STARSIGN_OFF) {
  $output = '';

  // Only show starsign when enabled
  if ($show > BIRTHDAYS_STARSIGN_OFF && !empty($starsign)) {
    // Image based on thme path.
    $output = '<img src="'. base_path() . drupal_get_path('module', 'birthdays') .'/starsigns/'. $starsign .'.gif" alt="'. t($starsign) .'" />';

    // If link should be shown: update $output
    if ($show == BIRTHDAYS_STARSIGN_LINK) {
      $output = '<a href="http://astrology.yahoo.com/astrology/general/dailyoverview/'. $starsign .'" target="_blank" title="'. t($starsign) .'">'. $output .'</a>';
    }
  }

  // Return HTML
  return $output;
}

/**
 * Get age from a given date of birth
 *
 * @var array $date
 *   array containing fields with keys 'year', 'month' and 'day'
 * @return int
 *   age
 */
function _birthdays_get_age($date) {
  // If date is not empty
  if (is_array($date)) {
    // extract date
    extract($date);

    // call main age function (no overloading in PHP)
    return _birthdays_calculate_age($day, $month, $year);
  }
  else {
    return NULL;
  }
}


/**
 * Calculate age
 *
 * @var $year, $month, $day as expected
 * @return int
 *   age
 */
function _birthdays_calculate_age($day, $month, $year) {
  if ($year && $month && $day) {
    // age = (current year - birthyear) - 1 (when the birthday hasn't arrived yet).
    return format_date(time(), 'custom', 'Y') - $year - (format_date(time(), 'custom', 'nd') < $month . str_pad($day, 2, 0, STR_PAD_LEFT));
  }
  else {
    return NULL;
  }
}


/**
 * Return age if user has agreed to show it
 *
 * @param object $account
 *   a user object having attribute "age" set
 * @return int
 */
function _birthdays_show_age($account) {
  $age = NULL;
  if (isset($account->age) && (variable_get('birthdays_hide_year', BIRTHDAYS_HIDE_YEAR_NO) == BIRTHDAYS_HIDE_YEAR_NO || (variable_get('birthdays_hide_year', BIRTHDAYS_HIDE_YEAR_NO) == BIRTHDAYS_HIDE_YEAR_USER && $account->birthdays_user_hide_year != BIRTHDAYS_HIDE_YEAR_USER_YES))) {
    $age = $account->age;
  }
  return $age;
}


/**
 * Format date array
 */
function _birthdays_show_date($date, $account, $format = 'small') {
  if (is_array($date)) {
    // Extract date
    extract($date);

    // Call main format function
    return _birthdays_show_date_2($day, $month, $year, $account, $format);
  }
  else {
    return NULL;
  }
}

/**
 * Format date, optionally hide year
 */
function _birthdays_show_date_2($day, $month, $year, $account, $type = 'small') {
  $output = '';
  // Determine format type
  switch ($type) {
    case 'medium':
      $format = variable_get('date_format_medium', 'D, m/d/Y - H:i');
      break;
    case 'small':
    default:
      $format = variable_get('date_format_short', 'm/d/Y - H:i');
  }

  // remove time from (- H:i)
  //$format = substr($format, 0, -6);

  // If admin or user decide to hide the age&year: hide year
  if ($year && ( variable_get('birthdays_hide_year', BIRTHDAYS_HIDE_YEAR_NO) == BIRTHDAYS_HIDE_YEAR_YES || (variable_get('birthdays_hide_year', BIRTHDAYS_HIDE_YEAR_NO) == BIRTHDAYS_HIDE_YEAR_USER && $account->birthdays_user_hide_year == BIRTHDAYS_HIDE_YEAR_YES))) {
    $year = NULL;
  }

  // Replacement array (can't use date() because of 1970 limitations in e.g. Windows PHP4)
  $replace = array(
    'd' => sprintf('%02d', $day),
    'D' => NULL,
    'j' => $day,
    'm' => sprintf('%02d', $month),
    'M' => map_month($month),
    'Y' => $year,
    'H:i' => NULL,
    'G:i' => NULL,
    'g:ia' => NULL,
    'F' => t(gmdate('F', mktime(0, 0, 0, $month, 15, 2000))),
  );

  // Translate string to correct format
  $output .= strtr($format, $replace);
  $output = trim($output, '/ ,.:-');

  return $output;
}

/**
 * Check which e-mail strings should be retreived, and fill in the default
 * placeholders. Uses the same method as _user_mail_text().
 */
function _birthdays_mail_text($key, $language = NULL, $variables = array()) {
  $langcode = isset($language) ? $language->language : NULL;

  // If the text is not the default, run it through strtr() to fill in the
  // placeholders.
  if ($text = variable_get('birthdays_send_user_' . $key, FALSE)) {
    return strtr($text, $variables);
  }
  else {
    // Which text do we want to retreive?
    switch ($key) {
      case 'subject':
        return t('Happy Birthday, !username!', $variables, $langcode);
      case 'message':
        return t("Hey !username,\n\nHappy birthday!\nWe hope you have a great day\n\nThe !site-team\n!uri_brief", $variables, $langcode);
    }
  }
}
